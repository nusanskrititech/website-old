<!doctype html>
<html lang="en">

<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9HEHBT8FQK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-9HEHBT8FQK');
    </script>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000" />

    <link rel="apple-touch-icon" sizes="180x180" href="assets/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="assets/img/favicon/site.webmanifest">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Roboto:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i|Dancing+Script" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="assets/css/style.css" rel="stylesheet">

    <title>Events by NU Sanskriti</title>
</head>

<body>

    <!-- ======= Header (Dynamic Include) ======= -->
    <div data-include="./navbar.html"></div>
        <div id="carouselExampleCaptions" class="carousel slide">
            <div class="carousel-indicators">
                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="1" aria-label="Slide 2"></button>
                <button type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide-to="2" aria-label="Slide 3"></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img src="./assets/img/events/dance.jpg" class="d-block w-100" alt="Vibrant Dance">
                    <div class="carousel-caption d-none d-md-block">
                        <h3>Be Vibrant</h3>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="./assets/img/caraousel/Copy of Holi-34.jpg" class="d-block w-100" alt="Creative Holi">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Be creative</h5>
                    </div>
                </div>
                <div class="carousel-item">
                    <img src="./assets/img/caraousel/@PRADNYAL.IO Tarang 2022-209.jpg" class="d-block w-100" alt="Community Event">
                    <div class="carousel-caption d-none d-md-block">
                        <h5>Join the community!</h5>
                    </div>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleCaptions" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </div>

    <main id="main">
        <div class="container py-5" style="background: #fff; color: #222; border-radius: 1.5rem; margin-top: 2rem; margin-bottom: 2.5rem; box-shadow: 0 4px 32px rgba(7,59,76,0.08);">
          <div class="text-center mb-4">
            <h1 class="display-5 fw-bold mb-3" style="color: #800000;">Upcoming Events</h1>
            <p class="lead mx-auto" style="max-width: 700px; color: #444;">Check out what's coming up next at NU Sanskriti! Join us for vibrant, creative, and community-driven experiences.</p>
          </div>
          <div id="upcoming-events-container" class="row g-4 justify-content-center"></div>
        </div>

        <div class="container py-5" style="background: #f8fafc; border-radius: 1.2rem; margin-bottom: 2.5rem; box-shadow: 0 2px 12px rgba(7,59,76,0.04);">
          <div class="text-center mb-4">
            <h2 class="fw-bold mb-3" style="color: #800000;">Past Events</h2>
            <p class="lead mx-auto" style="max-width: 700px; color: #444;">A look back at some of our favorite moments and milestones.</p>
          </div>
          <div id="past-events-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
        </div>
    </main>


    <!-- ======= Footer (Dynamic Include) ======= -->
    <div data-include="footer.html"></div>
    <script src="include.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const SHEET_ID = '1pFNJixtEwa-SuSwKNkKS6lJ2QU5Csx1P5yqtn2Q6YoU';
        const SHEET_GID = '0';
        const endpoint = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

function formatEventDateTime(dateStr, timeStr) {
    if (!dateStr || /tbd/i.test(dateStr)) return '';
    let [mm, dd, yyyy, hour, minute, second] = [null, null, null, 0, 0, 0];
    let dateObj = null;
    // Support MM-DD-YYYY, MM/DD/YYYY, Date(YYYY,MM,DD), Date(YYYY,MM,DD,HH,mm,ss)
    if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
        [mm, dd, yyyy] = dateStr.split('-');
    } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
        [mm, dd, yyyy] = dateStr.split('/');
    } else if (/^Date\((\d{4}),(\d{1,2}),(\d{1,2})(?:,(\d{1,2}),(\d{1,2}),(\d{1,2}))?\)$/.test(dateStr)) {
        // Google Sheets Date(YYYY,MM,DD[,HH,mm,ss]) format
        const match = dateStr.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})(?:,(\d{1,2}),(\d{1,2}),(\d{1,2}))?\)$/);
        if (match) {
            yyyy = match[1];
            mm = String(Number(match[2]) + 1).padStart(2, '0');
            dd = String(Number(match[3])).padStart(2, '0');
            if (match[4] !== undefined) hour = Number(match[4]);
            if (match[5] !== undefined) minute = Number(match[5]);
            if (match[6] !== undefined) second = Number(match[6]);
        }
    } else {
        // fallback to Date parsing
        const d = new Date(dateStr);
        if (isNaN(d)) return '';
        mm = String(d.getMonth() + 1).padStart(2, '0');
        dd = String(d.getDate()).padStart(2, '0');
        yyyy = String(d.getFullYear());
    }
    // Always use timeStr if present and valid
    let displayHour = 0, displayMinute = 0, displaySecond = 0, hasTime = false;
    if (timeStr && !/tbd/i.test(timeStr)) {
        // Support Google Sheets time-only pseudo-date: Date(1899,11,30,HH,MM,SS)
        let timeMatch = timeStr.match(/^Date\(1899,11,30,(\d{1,2}),(\d{1,2}),(\d{1,2})\)$/);
        if (timeMatch) {
            displayHour = parseInt(timeMatch[1], 10);
            displayMinute = parseInt(timeMatch[2], 10);
            displaySecond = parseInt(timeMatch[3], 10);
            hasTime = true;
        } else {
            let [h, m] = timeStr.split(':').map(x => x && x.trim());
            if (h !== undefined && m !== undefined && h !== '' && m !== '') {
                displayHour = parseInt(h, 10);
                displayMinute = parseInt(m, 10);
                displaySecond = 0;
                hasTime = true;
            }
        }
    } else if (hour !== 0 || minute !== 0 || second !== 0) {
        displayHour = hour;
        displayMinute = minute;
        displaySecond = second;
        hasTime = true;
    }
    // Log the parsed/displayed time for debugging
    console.log('[formatEventDateTime] Raw:', dateStr, '| TimeStr:', timeStr, '| displayHour:', displayHour, '| displayMinute:', displayMinute, '| displaySecond:', displaySecond, '| hasTime:', hasTime);
    // Create date in EST (America/New_York) with time
    dateObj = new Date(`${yyyy}-${mm}-${dd}T${String(displayHour).padStart(2, '0')}:${String(displayMinute).padStart(2, '0')}:${String(displaySecond).padStart(2, '0')}-05:00`);
    const options = { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric', timeZone: 'America/New_York' };
    let datePart = dateObj.toLocaleDateString('en-US', options);
    let timePart = '';
    if (hasTime) {
        let hour12 = displayHour % 12;
        if (hour12 === 0) hour12 = 12;
        let ampm = displayHour >= 12 ? 'pm' : 'am';
        timePart = `${hour12}:${String(displayMinute).padStart(2, '0')}${ampm}`;
    }
    return datePart + (timePart ? ' ' + timePart : '');
}

function createEventCard(event) {
    let imageUrl = event[3] && event[3].trim() ? event[3].trim() : 'assets/img/cs.jpg';
    if (imageUrl.includes('drive.google.com')) {
        // Support URLs like:
        // https://drive.google.com/file/d/FILE_ID/view?usp=sharing
        // https://drive.google.com/uc?export=view&id=FILE_ID
        // https://drive.google.com/open?id=FILE_ID
        let match = imageUrl.match(/file\/d\/([\w-]+)/);
        if (!match) {
            match = imageUrl.match(/uc\?export=view&id=([\w-]+)/);
        }
        if (!match) {
            match = imageUrl.match(/open\?id=([\w-]+)/);
        }
        if (match && match[1]) {
            imageUrl = `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
        } else {
            imageUrl = 'assets/img/cs.jpg';
        }
        console.log('[createEventCard] Final imageUrl:', imageUrl);
    }
    const image = `<img src="${imageUrl}" class="card-img-top" alt="${event[0]}" width="300" height="300" style="object-fit:cover;">`;

    // For past events, use PostEventLink (event[11]) if present, else default
    let isPastEvent = false;
    if (typeof window._isPastEvent === 'function') {
        isPastEvent = window._isPastEvent(event);
    }

    // Calculate event date/time for countdown and calendar
    let eventDateObj = parseEventDate(event[2]);
    let eventTimeStr = event[6] && !/tbd/i.test(event[6]) ? event[6].trim() : null;
    let eventDateTimeObj = null;
    if (eventDateObj && eventTimeStr) {
        // Try to add time to date
        let hour = 0, minute = 0, second = 0;
        let timeMatch = eventTimeStr.match(/^Date\(1899,11,30,(\d{1,2}),(\d{1,2}),(\d{1,2})\)$/);
        if (timeMatch) {
            hour = parseInt(timeMatch[1], 10);
            minute = parseInt(timeMatch[2], 10);
            second = parseInt(timeMatch[3], 10);
        } else {
            let parts = eventTimeStr.split(':');
            if (parts.length >= 2) {
                hour = parseInt(parts[0], 10);
                minute = parseInt(parts[1], 10);
            }
        }
        eventDateTimeObj = new Date(eventDateObj.getTime());
        eventDateTimeObj.setHours(hour, minute, second, 0);
    } else if (eventDateObj) {
        eventDateTimeObj = eventDateObj;
    }

    // Event Reminder (Google Calendar link)
    let reminderButton = '';
    if (eventDateTimeObj && !isPastEvent) {
        // Google Calendar expects YYYYMMDDTHHmmssZ (UTC)
        let startUTC = new Date(eventDateTimeObj.getTime());
        let endUTC = new Date(startUTC.getTime() + 2 * 60 * 60 * 1000); // default 2hr event
        function toCalStr(d) {
            return d.toISOString().replace(/[-:]/g, '').replace(/\.\d{3}Z$/, 'Z');
        }
        let calUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(event[0] || 'Event')}` +
            `&dates=${toCalStr(startUTC)}/${toCalStr(endUTC)}` +
            `&details=${encodeURIComponent(event[1] || '')}` +
            (event[5] ? `&location=${encodeURIComponent(event[5])}` : '') +
            `&sf=true&output=xml`;
        reminderButton = `<a href="${calUrl}" target="_blank" class="btn btn-outline-success w-100 mt-2">Add to Google Calendar</a>`;
    }

    // Countdown timer if event is less than a week away
    let countdownDiv = '';
    if (eventDateTimeObj && !isPastEvent) {
        const now = new Date();
        const diffMs = eventDateTimeObj.getTime() - now.getTime();
        if (diffMs > 0 && diffMs < 7 * 24 * 60 * 60 * 1000) {
            const countdownId = `countdown-${Math.random().toString(36).substr(2, 9)}`;
            countdownDiv = `<div class=\"mt-2\"><span id=\"${countdownId}\" class=\"badge bg-warning text-dark\"></span></div>`;
            setTimeout(() => {
                function updateCountdown() {
                    const now = new Date();
                    let diff = eventDateTimeObj.getTime() - now.getTime();
                    if (diff < 0) diff = 0;
                    const days = Math.floor(diff / (24*60*60*1000));
                    const hours = Math.floor((diff % (24*60*60*1000)) / (60*60*1000));
                    const mins = Math.floor((diff % (60*60*1000)) / (60*1000));
                    const secs = Math.floor((diff % (60*1000)) / 1000);
                    document.getElementById(countdownId).textContent = `Event starts in ${days}d ${hours}h ${mins}m ${secs}s`;
                }
                updateCountdown();
                const interval = setInterval(updateCountdown, 1000);
                setTimeout(() => clearInterval(interval), diffMs + 2000);
            }, 0);
        }
    }
    // Date/time in bold, above buttons
    let dateTimeVenue = '';
    if ((event[2] && !/tbd/i.test(event[2])) || (event[6] && !/tbd/i.test(event[6])) || (event[5] && !/tbd/i.test(event[5]))) {
        dateTimeVenue = `<div class="mb-2"><span class="fw-bold">${formatEventDateTime(event[2], event[6])}</span>${event[5] && !/tbd/i.test(event[5]) ? ' | ' + event[5] : ''}</div>`;
    }

    // Ticket button logic for upcoming events only
    let ticketButton = '';
    let ticketUrl = event[8] && event[8].trim() ? event[8].trim() : null;
    // Ensure ticketUrl is absolute (starts with http or https)
    if (ticketUrl && !/^https?:\/\//i.test(ticketUrl)) {
        ticketUrl = 'https://' + ticketUrl;
    }
    const ticketReleaseDate = event[9] && event[9].trim() ? event[9].trim() : null;
    const ticketReleaseTime = event[10] && event[10].trim() ? event[10].trim() : null;
    // Only show for upcoming events (not past)
    if (ticketUrl) {
        let showTicketLink = false;
        let releaseDisplay = '';
        let debugLog = {};
        if (ticketReleaseDate) {
            // Parse release date/time
            let releaseDateObj = null;
            let baseDate = null;
            let hour = 0, minute = 0, second = 0;
            if (ticketReleaseTime) {
                baseDate = parseEventDate(ticketReleaseDate);
                let timeMatch = ticketReleaseTime.match(/^Date\(1899,11,30,(\d{1,2}),(\d{1,2}),(\d{1,2})\)$/);
                if (timeMatch) {
                    hour = parseInt(timeMatch[1], 10);
                    minute = parseInt(timeMatch[2], 10);
                    second = parseInt(timeMatch[3], 10);
                } else {
                    let parts = ticketReleaseTime.split(':');
                    if (parts.length >= 2) {
                        hour = parseInt(parts[0], 10);
                        minute = parseInt(parts[1], 10);
                    }
                }
                if (baseDate) {
                    releaseDateObj = new Date(baseDate.getTime());
                    releaseDateObj.setHours(hour, minute, second, 0);
                }
            } else {
                releaseDateObj = parseEventDate(ticketReleaseDate);
            }
            // Now compare to now in EST
            const now = new Date();
            const nowEST = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
            debugLog = {
                eventTitle: event[0],
                ticketReleaseDate,
                ticketReleaseTime,
                baseDate: baseDate ? baseDate.toString() : null,
                hour, minute, second,
                releaseDateObj: releaseDateObj ? releaseDateObj.toString() : null,
                nowEST: nowEST.toString(),
                nowESTms: nowEST.getTime(),
                releaseDateObjms: releaseDateObj ? releaseDateObj.getTime() : null
            };
            console.log('[TicketButtonDebug]', debugLog);
            if (releaseDateObj && nowEST.getTime() >= releaseDateObj.getTime()) {
                showTicketLink = true;
            } else {
                releaseDisplay = formatEventDateTime(ticketReleaseDate, ticketReleaseTime);
            }
        } else {
            // No release date, always show
            showTicketLink = true;
        }
        if (showTicketLink) {
            ticketButton = `<button class="btn btn-primary w-100 mt-2" onclick="window.open('${ticketUrl}', '_blank')">Get Tickets</button>`;
        } else {
            ticketButton = `<button class="btn btn-secondary w-100 mt-2" disabled>Tickets go live on ${releaseDisplay}. Check back later.</button>`;
        }
    }

    // Truncate event description to 3 lines (CSS line-clamp)
    let eventDesc = event[1] || '';
    // Use a div with class for line clamp
    const descDiv = `<div class="card-text event-desc-clamp">${eventDesc}</div>`;

    // Modal trigger button
    const modalId = `eventModal-${Math.random().toString(36).substr(2, 9)}`;
    // modalDescription is event[12]
    let modalDescription = event[12] && event[12].trim() ? event[12].trim() : '';
    const cardBody = `
        <div class="card-body d-flex flex-column">
            <h5 class="card-title">${event[0] || ''}</h5>
            ${countdownDiv}
            ${dateTimeVenue}
            <div style="flex:1 1 auto;">
              ${descDiv}
            </div>
            <div class="mt-auto">
              ${ticketButton}
              ${reminderButton}
              <button class="btn btn-outline-info w-100 mt-2" data-bs-toggle="modal" data-bs-target="#${modalId}">More Details</button>
            </div>
        </div>
        <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}-label" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="${modalId}-label">${event[0] || ''}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <p>${event[1] || ''}</p>
                ${modalDescription ? `<div class='mb-2'>${modalDescription}</div>` : ''}
                <p><strong>Date:</strong> ${formatEventDateTime(event[2], event[6])}</p>
                ${event[5] ? `<p><strong>Location:</strong> ${event[5]}</p>` : ''}
                ${event[4] ? `<p><a href="${event[4]}" target="_blank">Event Link</a></p>` : ''}
                ${event[8] ? `<p><a href="${event[8]}" target="_blank">Ticket Link</a></p>` : ''}
                ${isPastEvent && event[11] ? `<p><a href="${event[11]}" target="_blank">Post Event Link</a></p>` : ''}
              </div>
            </div>
          </div>
        </div>
    `;
    // Only the card (not all buttons/links) should be clickable. Use a wrapper div for the card, and only add a click handler to the card if eventUrl is present.
    let eventUrl = event[4] && event[4].trim() ? event[4].trim() : null;
    if (isPastEvent) {
        let postEventLink = event[11] && event[11].trim() ? event[11].trim() : '';
        if (postEventLink) {
            if (!/^https?:\/\//i.test(postEventLink)) {
                postEventLink = 'https://' + postEventLink;
            }
            eventUrl = postEventLink;
        } else {
            eventUrl = 'https://go.nusanskriti.org/instagram-website';
        }
    }
    if (eventUrl && !/^https?:\/\//i.test(eventUrl)) {
        eventUrl = 'https://' + eventUrl;
    }
    // Debug log for eventUrl and all relevant links
    console.log('[EventCardDebug]', {
        eventTitle: event[0],
        eventUrl,
        ticketUrl,
        reminderButton,
        modalId
    });
    // Card with stretched-link as first child, so inner buttons/links are above it
    let stretchedLink = '';
    if (eventUrl) {
        stretchedLink = `<a href="${eventUrl}" target="_blank" class="stretched-link event-main-link" tabindex="-1" aria-label="Event main link" style="z-index:1;"></a>`;
    }
    // Place stretched-link as first child of card
    const cardInner = `<div class="card h-100 position-relative event-card-clickable">${stretchedLink}${image}${cardBody}</div>`;
    let cardContent = `<div class="col d-flex align-items-stretch position-relative">${cardInner}</div>`;
    return cardContent;
}

// Add CSS for line clamp, clickable card, and fix z-index for inner buttons/links

const style = document.createElement('style');
style.innerHTML = `
.event-card-clickable {
  cursor: pointer;
  width: 320px;
  max-width: 100%;
  margin-left: auto;
  margin-right: auto;
  display: flex;
  flex-direction: column;
}
@media (max-width: 400px) {
  .event-card-clickable {
    width: 100% !important;
    min-width: 0 !important;
  }
}
.event-card-clickable .card-img-top {
  object-fit: cover;
}
.event-desc-clamp {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  word-break: break-word;
  hyphens: auto;
}
.event-card-clickable .btn,
.event-card-clickable a.btn,
.event-card-clickable .btn-outline-info,
.event-card-clickable .btn-primary,
.event-card-clickable .btn-secondary,
.event-card-clickable .btn-outline-success {
  position: relative;
  z-index: 2;
}
.event-card-clickable .card-text a,
.event-card-clickable .modal-body a {
  position: relative;
  z-index: 2;
}
.event-main-link {
  z-index: 1 !important;
}
`;
document.head.appendChild(style);
        
        // Robust Date Parsing Function (returns a Date at midnight EST, or null)
        function parseEventDate(dateStr) {
            if (!dateStr || /tbd/i.test(dateStr)) return null;
            let raw = dateStr;
            dateStr = dateStr.trim();
            // Remove zero-width and non-breaking spaces
            dateStr = dateStr.replace(/[\u200B-\u200D\uFEFF\u00A0]/g, '');
            console.log('[parseEventDate] Raw:', raw, '| Trimmed:', dateStr);
            let [mm, dd, yyyy] = [null, null, null];
            if (/^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                [mm, dd, yyyy] = dateStr.split('-');
            } else if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                [mm, dd, yyyy] = dateStr.split('/');
            } else if (/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/.test(dateStr)) {
                // Google Sheets Date(YYYY,MM,DD) format, MM is zero-based
                const match = dateStr.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
                if (match) {
                    yyyy = match[1];
                    mm = String(Number(match[2]) + 1).padStart(2, '0'); // zero-based month
                    dd = String(Number(match[3])).padStart(2, '0');
                }
            } else {
                // fallback to Date parsing
                const d = new Date(dateStr);
                if (isNaN(d)) {
                    console.warn('[parseEventDate] Invalid date after fallback:', dateStr);
                    return null;
                }
                mm = String(d.getMonth() + 1).padStart(2, '0');
                dd = String(d.getDate()).padStart(2, '0');
                yyyy = String(d.getFullYear());
            }
            // Create date in EST (America/New_York)
            // Use UTC to avoid timezone offset issues
            const result = new Date(`${yyyy}-${mm}-${dd}T05:00:00Z`); // 00:00 EST is 05:00 UTC
            if (isNaN(result)) {
                console.warn('[parseEventDate] Final constructed date is invalid:', `${yyyy}-${mm}-${dd}T05:00:00Z`);
                return null;
            }
            return result;
        }

        // Helper to determine if an event is past (for use in createEventCard)
        window._isPastEvent = function(event) {
            const dateStr = event[2];
            const eventDate = parseEventDate(dateStr);
            const now = new Date();
            const todayEST = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 5, 0, 0));
            if (!eventDate) return false;
            return eventDate.getTime() < todayEST.getTime();
        };

        fetch(endpoint)
            .then(res => res.text())
            .then(text => {
                const json = JSON.parse(text.substr(47).slice(0, -2));
                if (!json.table || !json.table.rows) return;
                
                const events = json.table.rows.map(row => (row.c || []).map(cell => (cell ? cell.v : null)));

                // Get today's date at midnight EST
                const now = new Date();
                const todayEST = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), 5, 0, 0)); // 00:00 EST is 05:00 UTC

                const upcoming = [];
                const past = [];

                events.forEach(event => {
                    if (!Array.isArray(event)) return;
                    const dateStr = event[2];
                    const eventDate = parseEventDate(dateStr);
                    // Debug logging
                    // event[7] is assumed to be showOnTop
                    console.log('Event:', event[0], '| Raw date:', dateStr, '| Parsed:', eventDate, '| TodayEST:', todayEST, '| showOnTop:', event[7]);
                    if (eventDate === null) {
                        upcoming.push(event); // TBD and invalid dates go to upcoming
                    } else if (eventDate.getTime() >= todayEST.getTime()) {
                        upcoming.push(event);
                    } else {
                        past.push(event);
                    }
                });

                // Separate upcoming events with showOnTop==1
                const showOnTopEvents = [];
                const normalUpcoming = [];
                upcoming.forEach(event => {
                    // Only consider showOnTop for upcoming events
                    if (event[7] == 1 || event[7] === '1') {
                        showOnTopEvents.push(event);
                    } else {
                        normalUpcoming.push(event);
                    }
                });

                // Sort showOnTopEvents and normalUpcoming by date (TBD/null first)
                function sortByDate(a, b) {
                    const dateA = parseEventDate(a[2]);
                    const dateB = parseEventDate(b[2]);
                    if (!dateA) return -1; // TBD events first
                    if (!dateB) return 1;
                    return dateA - dateB;
                }
                showOnTopEvents.sort(sortByDate);
                normalUpcoming.sort(sortByDate);
                past.sort((a, b) => {
                    const dateA = parseEventDate(a[2]);
                    const dateB = parseEventDate(b[2]);
                    if (!dateA) return 1; // TBD events last
                    if (!dateB) return -1;
                    return dateB - dateA; // Sort by most recent first
                });

                // Concatenate showOnTop events first, then the rest
                const finalUpcoming = [...showOnTopEvents, ...normalUpcoming];

                document.getElementById('upcoming-events-container').innerHTML = finalUpcoming.length ? finalUpcoming.map(createEventCard).join('') : '<p class="col-12">No new events scheduled at the moment. Check back soon!</p>';
                document.getElementById('past-events-container').innerHTML = past.length ? past.map(createEventCard).join('') : '<p class="col-12">Our past events will be listed here.</p>';
            })
            .catch(err => {
                console.error('Error loading events:', err);
                document.getElementById('upcoming-events-container').innerHTML = '<p class="col-12 text-danger">Could not load events. Please try again later.</p>';
            });
    </script>
</body>
</html>